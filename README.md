# Домашнее задание к занятию "`Базы данных, их типы`" - `Евгений Головенко`

---

### Задание 1. СУБД

### Кейс
Крупная строительная компания, которая также занимается проектированием и девелопментом, решила создать 
правильную архитектуру для работы с данными. Ниже представлены задачи, которые необходимо решить для
каждой предметной области. 

Какие типы СУБД, на ваш взгляд, лучше всего подойдут для решения этих задач и почему? 
 
### Вопрос 1.1.
Бюджетирование проектов с дальнейшим формированием финансовых аналитических отчётов и прогнозирования рисков.
СУБД должна гарантировать целостность и чёткую структуру данных.

### Ответ 1.1.
Данным требованиям отвечает реляционная СУБД (Oracle, MS SQL, PostgreSQL).
Эти СУБД полностью отвечают принципам ACID, обеспечивают четкую структуру и целостность данных.
Для визуализации данных, анализа и прогноза можно использовать надстройку, например Tableau или Power BI.

### Вопрос 1.1.* 
Хеширование стало занимать длительно время, какое API можно использовать для ускорения работы? 

### Ответ 1.1.*
Используем теорему PACELС. В случае хеширования в финансовой системе (бюджеты, аналитика) Consistency в приоритете, потому что хеш служит контролем целостности.
Если хеш-функция медленная, то растёт Latency, что в свою очередь снижает производительность вычислений.
Соответственно необходим API, который обеспечивает Consistenc уменьшая Latency. После обзора того, что предлагается, сравнения практик и бенчмаркинга различных API я бы предложил использовать ["BLAKE3"](https://github.com/BLAKE3-team/BLAKE3)

### Вопрос 1.2.
Под каждый девелоперский проект создаётся отдельный лендинг, и все данные по лидам стекаются в CRM к 
маркетологам и менеджерам по продажам. Какой тип СУБД лучше использовать для лендингов и для CRM? 
СУБД должны быть гибкими и быстрыми.

### Ответ 1.2.
Главная задача лендинга собрать контакты потенциальных клиентов (лиды). Требования к лендингу, это работать очень быстро, выдерживать всплески трафика (старт рекламы) и хранить разные формы заявок (шаблоны у проектов могут отличаться).
Гибкость, или изменчивость форм, может предполагать использование NoSQL, допустим MongoDB. Это гибкая схема, высокая скорость записи, масштабированость.
Далее, собранные данные нужно структурировать и передать в CRM. CRM это про бизнес-процесс со строгими связями и правилами, нечто вроде: клиент - менеджер - активность клиента - задача - статус - сделка - анализ. Для строгой структуры предпочтительнее использовать реляционные СУБД, и пусть это будет PostgreSQL.

### Вопрос 1.2.* 
Можно ли эту задачу закрыть одной СУБД? И если да, то какой именно СУБД и какой реализацией?

### Ответ 1.2.*
Есть мнение, что эту задачу возможно решить в PostgreSQL с JSONB. JSONB это формат для хранения полуструктурированных данных JSON в бинарном формате, который ускоряет операции чтения и поиска по сравнению с обычным текстовым JSON. Утверждается, что JSONB позволяет хранить данные с переменной схемой в одном столбце, сочетая гибкость NoSQL с надежностью и возможностями реляционной базы данных. 
Т.е. лиды собираем и храним в JSONB, CRM живет в таблицах. Хотя я бы предпочел вариант с двумя СУБД (если бюджет позволит).

### Вопрос 1.3. 
Отдел контроля качества решил создать базу по корпоративным нормам и правилам, обучающему материалу и так далее, сформированную согласно структуре компании. СУБД должна иметь простую и понятную структуру.

### Ответ 1.3.
Если позволяет бюджет и обстоятельства, то я бы рекомендовал использовать уже готовое решение, например ["Confluence"](https://www.atlassian.com/software/confluence)
Но в условиях вынужденной самодостаточности, закрытой корпоративной культуры и всего такого базу знаний компании можно сотворить в PostgresSQL с tsvector (полнотекстовый поиск). Документы достаточно удобно хранить в JSON, реляционная база даст вполне простую схему и полнотекстовый поиск, можно реализовать версии документов через отдельные таблицы.
Если руководство предпочитает работать именно с документами, то в этом случае базу знаний можно попробовать реализовать в NoSQL, вроде MongoDB.

### Вопрос 1.3.* 
Можно ли под эту задачу использовать уже существующую СУБД из задач выше и если да, то как лучше это 
реализовать?

### Ответ 1.3.
В принципе, ничто не помешает реализовать базу знаний компании в той же СУБД PostgreSQL, в которой крутится лендинг и CRM, но в отдельной схеме или базе данных. Так будет проще с авторизацией, бэкапами, интеграцией с другими системами. Но возможно в целом снижение производительности (оперативные транзакции будут не такие оперативные при тяжелых запросах или индексации). Было бы разумно и безопасно организовать Row-Level Security и роли, когда данные на уровне каждой отдельной строки скрываются или показываются в зависимости от прав пользователя, связанного с определенной ролью. И вообще, чем проще система, тем меньше вероятность отказа.

### Вопрос 1.4. 
Департамент логистики нуждается в решении задач по быстрому формированию маршрутов доставки материалов по объектам и распределению курьеров по маршрутам с доставкой документов. СУБД должна уметь быстро работать со связями.

### Ответ 1.4.
Так как уже данность сложилась по предыдущим заданиям, будем использовать СУБД PostgreSQL + PostGIS (позволяет хранить картографические данные  непосредственно в базе данных и выполнять сложные запросы к ним, как к обычным табличным данным, но с учетом пространственной логики) + pgRouting (маршрутизация и решения сетевых задач). Геоданные и трассы храним в PostGIS, используем pgRouting для маршрутизации. Если запросов много и они частые, можно использовать кеширование в Redis (быстрая база данных с хранением данных в оперативной памяти).


### Вопрос 1.4.* 
Можно ли к этой СУБД подключить отдел закупок или для них лучше сформировать свою СУБД в связке с СУБД логистов?

### Ответ 1.4.* 
С точки зрения бизнес-логики и проведения транзакций внутри СУБД (заявка бизнеса - проверка запасов - закупка), то логичнее это реализовать в единой СУБД. Но если отдел закупок уже имеет свой нагруженный ERP, то лучше для них создать отдельную базу данных и интегрировать ее через API. Независимые системы проще масштабировать и нет взаимовлияния на транзакции.

### Вопрос 1.5.* 
Можно ли все перечисленные выше задачи решить, используя одну СУБД? Если да, то какую именно?

### Ответ 1.5.* 
Технически можно. PostgreSQL с дополнительными библиотеками вполне может закрыть все задачи.
Критерии выбора: строгие данные имеются, гибкость данных - JSONB в помощь, геоданные и маршруты реализуются через PostGIS+pgRouting, версионность данных имеется, текстовый поиск через tsvector.

---

### Задание 2. Транзакции

### Вопрос 2.1.
Пользователь пополняет баланс счёта телефона, распишите пошагово, какие действия должны произойти для того, чтобы 
транзакция завершилась успешно. Ориентируйтесь на шесть действий.

### Ответ 2.1.
Логика действий:
1. Начало транзакции. Блокируются нужные версии строк. Блокировка строк исключает одновременные изменения баланса другими транзакциями.
2. Проверка данных, существует ли аккаунт и можно ли принять платёж.
3. Внесение записи о новом платеже и его статусе. Начальный статус, пусть будет `processing`.
4. Изменяем баланса пользователя (текущий баланс + amount).
5. Обновлеем статуса платежа (успешно ли все прошло или нет) 
6. Коммитим изменения. Если все прошло успешно, то изменения становятся доступны другим транзакциям. Если нет, то выполняется Rollback и все откатывается на исходную позицию, баланс пользователя не меняется.

### Вопрос 2.1.* Какие действия должны произойти, если пополнение счёта телефона происходило бы через автоплатёж?
В принципе логика та же, только транзакция инициируется не пользователем, а скриптом.
Добавляется вначале шаг проверки баланса пользователя. 
Если баланс меньше или равен какого-то значения, то создается задача автоплатежа на заданную сумму.
Далее то же, что и в предыдущем задании.

--

### Вопрос 3.1. 
Напишите пять преимуществ SQL-систем по отношению к NoSQL. 

### Ответ 3.1.
1. Целостность данных (ACID). NoSQL часто использует BASE, где возможны временные несогласованности.
2. Структурированные данные. Таблицы и связи между ними позволяют гарантировать корректность данных и предотвращать ошибки на уровне структуры. Идеально для финансов, SRM, ERP.
3. Собственно, сам язык SQL. Позволяет делать сложные операции, слияния без дополнительного кода. 
4. Стандартицация. За долгую историю сформировалась экосистема со множеством инструментов, библиотек, расширений. Множество провессиональных сообществ.
5. Ввиду широкого распространения SQL-систем и их востребованности даже базовые знания SQL позволяют затюнинговать свое CV и улучшить шансы в поиске работы.

### Вопрос 3.1.* 
Какие, на ваш взгляд, преимущества у NewSQL систем перед SQL и NoSQL.

### Ответ 3.1.*
Целью создания NewSQL-систем является обеспение масштабируемости системы NoSQL, сохраняя при этом согласованность традиционной системы баз данных.

Преимущества перед SQL:

- Горизонтальное масштабирование (SQL обычно масштабируется вертикально).

- Распределённость и отказоустойчивость на уровне кластера.

- Высокая производительность при больших нагрузках.

Преимущества перед NoSQL:

- ACID-транзакции, как в обычных SQL.

- Строгая схема и целостность данных.

- Поддержка SQL-запросов.

--

### Задание 4. Кластеры

Необходимо производить большое количество вычислений при работе с огромным количеством данных, под эту задачу выделено 1000 машин. 

На основе какого критерия будете выбирать тип СУБД и какая модель *распределённых вычислений* 
здесь справится лучше всего и почему?

### Ответ 4.
Если говорить про большое количество вычислений, то скорее всего в задании имеется ввиду характер нагрузки `аналитика `.
Требования к подобной системе могут быть следующими:

- обработка огромного количества данных
- горизонтальная масштабируемость на значительное количество узлов (в данном случае 1000)
- высокая скорость обработки запросов (просканировать объем данных и произвести вычисления).

Полагаю, что `column-oriented` СУБД будет отвечать этим требованиям.

Так как про модели распределенных вычислений на вебинаре не говорилось, то приведу здесь краткий обзор из чего выбирать. Итак, выбор проводился из следующих моделей:

- Shared Disk. Все узлы имеют общий диск, но раздельную память и CPU.
  Как работает:
  - каждый сервер может обращаться к общему хранилищу;
  - координируют блокировки, транзакции, кэш.
  Характеристики:
  - надежный, при удалении/добавлении узлов данные не теряются;
  - ограниченная масштабируемость, т.к. с увеличением узлов требуется увеличение блокировок, межузловой синхронизации, увеличивается обмен измененными таблицами. I/O  производится в общий диск. Каким бы быстрым он не был, но есть ограничение точек доступа и общий контроль очереди.

- Shared Nothing. Каждый узел работает полностью независимо и имеет свои CPU, RAM, хранилище, часть данных.
  Как работает:
  - На каждом узле свой экземпляр СУБД, свое хранилище;
  - Данные разбиваются по узлам;
  - Запрос (SQL или аналитический job) либо выполняется локально, если запрос глобальный, то рассылается на узлы, определенные узлом-координатором;
  - Каждый узел параллельно обрабатывает свою часть данных;
  - Результаты собираются и агрегируются узлом-координатором.
  Характеристики:
  - масштабируется горизонтально;
  - узлы независимы;
  - умеет «переливать» данные между узлами;
  - чем больше узлов, тем быстрее.

Собственно, исходя из вышеупомянутого, производить большое количество вычислений при работе с огромным количеством данных на 1000 машинах целесообразно с использованием `column-oriented` СУБД (например ["ClickHouse"](https://clickhouse.com/)) и модели распределенных вычислений `Shared nothing`. 
